**Diff 算法**（也称为差异比较算法或协调算法）是一种用于确定新旧虚拟 DOM 树之间差异的方法。这个算法的目的是找出哪些部分的 DOM 需要更新，以减少不必要的 DOM 操作，从而提高性能。

## 算法步骤
1. **比较同层级节点**: 从树的顶部开始，逐层向下比较同层级的节点。
2. **元素复用**: 如果新旧节点类型和 key 相同，框架会复用现有的 DOM 元素，而不是重新创建。
3. **列表比较**: 对于列表（数组），Diff 算法会尝试通过 key 来识别元素，以确定哪些元素是新添加的、被删除的或被移动的。
4. **最小化 DOM 操作**: 算法会生成一个最小的操作序列，以更新 DOM，包括添加、删除和移动 DOM 元素。
5. **批量更新**: 算法会将多个更新操作合并为单个重绘或重排，以减少性能损耗。

## 性能优化
- **避免不必要的 DOM 操作**: 通过精确识别哪些部分需要更新，Diff 算法减少了对 DOM 的操作次数。
- **减少重绘和重排**: 通过批量处理 DOM 更新，算法减少了浏览器的重绘和重排次数。

## 限制
- **不同层级不交换**: Diff 算法通常不会将不同层级的节点交换位置，因为这会导致复杂的 DOM 操作。
- **文本节点优化**: 对于文本节点，如果内容发生变化，Diff 算法通常会替换整个文本节点，而不是尝试局部更新。

## Vue对Diff算法的优化

- **动静结合与 Patch Flag**：在创建虚拟 DOM（vnode）时，会根据 vnode 内容是否可变化添加静态标记 Patch Flag。在 diff 过程中，只会比较有 Patch Flag 的节点，减少了不必要的对比。Patch Flag 有多种枚举值，例如 TEXT 表示可变化文本节点，还有动态 class、动态 style、动态属性、动态 key 属性等。这样在 diff 时只需比对相应类型的变化，比如对于标记为 TEXT 的节点，只需比对文本内容，提高了 diff 效率。
- **静态提升（hoistStatic）**：在 Vue2 中，无论元素是否参与更新，每次触发更新都会重新创建所有 vnode。而 Vue3 对于不参与更新的 vnode，会做静态提升，只创建一次并保存其引用，在后续的 re-render 时直接复用，避免了重复创建的开销。
- **事件侦听缓存（cacheHandlers）**：在 Vue2 中，`onClick`等事件会被视为动态绑定，每次 diff 时都要追踪其变化。而在 Vue3 中，如果事件是不会变化的，会将其缓存起来，该节点也不会被标记上 Patch Flag，从而在 render 和 diff 阶段都节约了不必要的性能消耗。
- **使用最长递增子序列优化对比流程**：在 Vue2 的`updateChildren`函数中对比变更，而 Vue3 主要在`patchKeyedChildren`函数里进行。例如对于新旧 children 数组（如老的 children：`(a, b, c, d, e, f, g)`，新的 children：`(a, b, f, c, d, e, h, g)`），会先进行头和头比、尾和尾比，得到部分相同节点；再保存未比较过的节点，并通过映射获取它们在数组中的下标，生成新数组；然后取出新数组中的最长递增子序列，最后只需将其他剩余节点基于该子序列的位置进行移动、添加或删除操作，而不是像 Vue2 中进行多种可能的比较，提高了对比效率。
# 浏览器缓存（强缓存和协商缓存）

当用户访问网站时，浏览器会将一些资源（如图片、脚本、样式表等）存储在本地，以便下次访问时可以直接从本地读取，而无需再次从服务器下载。

浏览器缓存主要有以下几种类型：

### 强缓存（Strong Caching 或 HTTP Cache-Control）：

通过设置响应头的 `Cache-Control` 和 `Expires` 字段来实现，在缓存有效期内，直接使用缓存，不会向服务器发送请求。

### 协商缓存（Negotiate Caching 或 Conditional Caching）：

当强缓存失效后，浏览器会发送请求到服务器，通过响应头的 `Last-Modified` 和 `ETag` 等字段与服务器进行协商，确定是否使用缓存。

## HTTP 状态码

### 强缓存

-   200 OK (form disk cache)
    -   不访问服务器，从硬盘中读取
    -   浏览器关闭后不会释放
-   200 OK (from memory cache)
    -   不访问服务器，从内存中读取
    -   浏览器关闭后就释放了

### 协商缓存

-   304 Not Modified
    -   浏览器向服务器发送请求，请求头包含之前存储的一些版本信息。服务器收到请求后会比较请求与服务器上资源的版本信息。
    -   如果资源没有变化，服务器会返回一个 304 Not Modified 状态码，告诉浏览器可以继续使用本地资源
    -   如果资源发生变化，服务器会返回新的资源和相应的 HTTP 状态码（通常是 200 OK），并更新浏览器缓存

## 请求头和响应头

### 强缓存

#### 请求头

无特定请求头，浏览器根据响应头中的指令决定是否使用强缓存

#### 响应头

-   `Cache-Control`：包含多种指令，如 max-age（资源能够被缓存多久），no-cache（需要重新验证），no-store（不允许缓存）等。
-   `Expires`：资源过期的具体时间点，通常与 Cache-Control 一起使用。

##### Cache-Control 常用指令

`public` ： 指示响应可以被任何中间缓存存储。
`private` ： 指示响应是为单个用户准备的，不能被共享缓存存储。
`no-cache` ： no-cache 的行为是要求浏览器或中间缓存在再次使用缓存的数据之前，必须与服务器进行验证，以确保数据是最新的（触发**协商缓存**的验证机制）
`no-store` ： 指示缓存不应存储请求或响应的任何部分。
`max-age=<seconds>` ： 指示资源能够被缓存多久（以秒为单位）。超过这个时间后，资源被认为是过期的。
`s-maxage=<seconds>` ： 与 max-age 类似，但仅适用于共享缓存（如代理服务器）。如果同时指定了 max-age 和 s-maxage，共享缓存将优先使用 s-maxage。

### 协商缓存

#### 请求头

-   `If-Modified-Since`：
    -   这个请求头的**值**是从先前相应资源的 `Last-Modified` 响应头中获取的。
    -   如果资源上次请求后没有被修改，则发送 304 Not Modified 响应。
-   `If-None-Match`：
    -   这个请求头的**值**是从先前相应资源的 `ETag` 响应头中获取的。
    -   这个请求头用于 ETag 验证，如果 ETag 没有变化，则发送 304 Not Modified 响应。

#### 响应头

-   `Last-Modified`：资源上次被修改的**日期和时间**。服务器用这个头来支持基于时间的验证。
-   `ETag`：资源的**特定版本的标识符**。这个标识符是服务器生成的，通常是一个哈希值，用于更精确地验证资源是否有变化。（ `ETag` 优先级比 `Last-Modified` 高）

## 请求处理流程

### 强缓存

1. 首次请求：
    - 用户访问网页，浏览器向服务器发送请求。
    - 服务器响应请求，并将资源（如 HTML、CSS、JavaScript 文件、图片等）发送给浏览器。
2. 设置缓存规则：
    - 服务器在响应头中设置 `Cache-Control` 指令，如 `max-age`，告诉浏览器资源在多久内被视为新鲜。
3. 存储资源：
    - 浏览器接收到资源后，根据响应头中的缓存规则，将资源存储在本地缓存中。
4. 再次请求：
    - 当用户再次请求相同资源时，浏览器首先检查本地缓存中是否有该资源，以及是否仍在 `max-age` 指定的新鲜期内。
5. 使用缓存资源：
    - 如果资源在缓存中且未过期，浏览器直接使用本地缓存的资源，而不会向服务器发送请求。
6. 资源过期：
    - 当资源超过 `max-age` 指定的时间后，浏览器在下次请求时会忽略本地缓存，重新向服务器请求资源。

### 协商缓存

1. 首次请求：
    - 同强缓存的首次请求。
2. 设置验证标记：
    - 服务器在响应头中除了设置 `Cache-Control` 外，还会设置 `ETag` 或 `Last-Modified` 等验证标记。
3. 存储资源和验证标记：
    - 浏览器存储资源的同时，也存储这些验证标记。
4. 再次请求前的验证：
    - 用户再次请求相同资源时，浏览器检查本地缓存中的资源和验证标记。
5. 发送条件请求：
    - 浏览器根据存储的验证标记，向服务器发送带有 `If-None-Match`（基于 ETag）或 `If-Modified-Since`（基于 Last-Modified）的请求头的条件请求。
6. 服务器验证：
    - 服务器接收到条件请求后，会比较请求头中的验证信息与当前资源的状态。
7. 返回结果：
    - 如果资源未变化，服务器返回 304 Not Modified 状态码，浏览器继续使用本地缓存的资源。
    - 如果资源有更新，服务器返回新的资源和 200 OK 状态码，浏览器更新本地缓存。

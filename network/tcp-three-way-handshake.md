# TCP 三次握手

-   **SYN（Synchronize Sequence Numbers）**：**同步序列号**。SYN 是一个 TCP 控制位，用于建立连接时同步双方的初始序列号。
-   **ACK（Acknowledgment Number）**：**确认编号**。ACK 是一个 TCP 控制位，用来确认收到的数据。ACK 编号表示接收方期望收到的下一个字节的序列号。
-   **ISN（Initial Sequence Number）**：**初始序列号**。ISN 是 TCP 连接建立时发送方选择的起始序列号，用于标识连接中的第一个数据字节。
-   **FIN（Finish）**：**结束**。FIN 是一个 TCP 控制位，用于关闭连接时指示发送方已经完成发送数据，希望终止连接。
-   **SEQ（Sequence Number）**：**序列号**。
-   **标志位设为 1**：特定的控制位被激活或启用

## TCP 三次握手（建立连接）

![TCP 三次握手](/network/assets/tcp-three-way-handshake/tcp-three-way-handshake.png)

1. **SYN (SEQ=x)（同步）**：客户端选择一个初始序列号（ISN），发送一个 TCP 段给服务器，其中 SYN 标志位设为 1，表示希望建立连接。
2. **SYN-ACK (SEQ=y,ACK=x+1)（同步确认）**：服务器收到客户端的 SYN 段后，如果同意建立连接，会发送一个 TCP 段作为响应。这个段的 SYN 标志位和 ACK（确认）标志位都设为 1，并且 ACK 编号是客户端的 ISN 加 1，同时服务器也选择自己的初始序列号。
3. **ACK (ACK=y+1)（确认）**：客户端收到服务器的 SYN-ACK 段后，发送一个 TCP 段作为最后的确认，其中 ACK 标志位设为 1，序列号是服务端发送的 ISN 加 1，ACK 编号是服务器的 ISN 加 1。

### 为什么要三次握手

三次握手的主要目的是为了确认双方的接收能力和发送能力是否正常，以建立可靠的连接。

**如果采用两次握手**：可能客户端或者服务端某个接收或发送能力出现异常，这样就无法建立正确连接，正常的一端会重新发送。等恢复后又会把第一次的连接当成正常的连接，等待接收数据，导致浪费资源等待。

-   **避免重复连接**：如果使用两次握手，客户端可能在连接请求丢失的情况下重复发送请求，导致服务器端建立多个连接实例。
-   **防止连接请求的重放攻击**：通过交换序列号，可以检测并防止旧的或重复的连接请求被接受。
-   **确保双方的接收和发送能力**：三次握手确保了客户端和服务器都能够接收和发送数据。客户端通过发送 SYN 确认它能够发送和接收；服务器通过发送 SYN-ACK 确认它能够接收和发送；客户端通过发送 ACK 确认它能够接收。
-   **初始化序列号**：三次握手过程中交换的序列号用于初始化连接的序列号，这对于维持数据包的顺序和确保可靠传输至关重要。

## TCP 四次挥手（关闭连接）

![TCP 四次挥手](/network/assets/tcp-three-way-handshake/tcp-four-way-handshake.png)

1. **FIN (SEQ=x)（结束）**：假设客户端希望关闭连接，它会发送一个 TCP 段，其中 FIN 标志位设为 1，用来关闭主动打开的连接方向。这时客户端进入 FIN-WAIT-1 状态。这表明客户端已经没有数据要发送给服务器了，但仍可以接收服务器发送的数据。
2. **ACK (ACK=x+1)（确认）**：服务器收到 FIN 后，发送一个确认 ACK，进入 CLOSE-WAIT 状态。客户端收到 ACK 后进入 FIN-WAIT-2 状态。此时客户端到服务器的连接已经关闭，但服务器到客户端的连接还未关闭，服务器可能还有一些数据要发送给客户端。
3. **FIN (SEQ=y)（结束）**：服务器发送完数据后，再发送一个 FIN 报文，用来关闭服务器到客户端的数据传送，服务器进入 LAST_ACK 状态。
4. **ACK (ACK=y+1)（确认）**：客户端收到 FIN 后，客户端进入 TIME_WAIT 状态，发送 ACK 报文给服务器，ACK 置为 1，确认号为 ack=w+1，序列号为 seq=v+1。服务器收到 ACK 后进入 CLOSED 状态，完成四次挥手。客户端在 TIME_WAIT 状态等待 2MSL（Maximum Segment Lifetime，报文最大生存时间）后，如果没有收到服务器的重传 FIN 报文，才会进入 CLOSED 状态。这样做的目的是确保客户端发送的最后一个 ACK 报文能够被服务器收到，以及让旧的数据包在网络中因过期而消失，防止已关闭的连接中残留的数据包影响新的连接。

### 为什么需要四次挥手？

TCP 连接是全双工的，即数据可以在两个方向上流动，因此每个方向都必须单独进行关闭。关闭一个方向上的连接需要一次请求和一次确认，所以总共需要四次挥手。

### 第二次的 ACK 和第三次的 FIN 不合并的原因

在第二次挥手时，服务器不能立即发送 FIN 报文与 ACK 合并，是因为服务器可能还有数据要发送给客户端。（**在 FIN 和 ACK 之间，服务器可能还有数据要发送给客户端**）

### 为什么有 TIME-WAIT 状态？

1. **确保可靠的连接终止**：TIME_WAIT 状态可以确保最后的 ACK 能够被对方正确接收，防止对方因为网络延迟等原因没有收到 ACK 而重传 FIN。
2. **让旧连接的数据包自然消亡**：在网络中可能存在延迟的数据包，TIME_WAIT 状态可以让这些旧数据包在网络中过期消失，避免它们影响到新的连接。
3. **防止端口资源被立即重用**：如果没有 TIME_WAIT 状态，新连接可能会收到旧连接的残留数据，导致数据错乱。TIME_WAIT 状态可以保证端口在一定时间内不会被立即重用，给旧连接的残留数据足够的时间消失。
